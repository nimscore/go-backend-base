# Ленты контента

## Обзор

FeedService предоставляет два типа лент: публичные ленты "лучшего" контента с ранжированием по популярности и персонализированные ленты на основе подписок и членства в сообществах.

## gRPC Service: FeedService

Proto файл: `proto/feed.proto`

## Сущности

### TimePeriod

```protobuf
enum TimePeriod {
  TIME_PERIOD_UNSPECIFIED = 0
  TIME_PERIOD_TODAY       = 1
  TIME_PERIOD_WEEK        = 2
  TIME_PERIOD_MONTH       = 3
  TIME_PERIOD_YEAR        = 4
  TIME_PERIOD_ALL_TIME    = 5
}
```

## Endpoints

### GetFeed

**RPC:** `GetFeed(GetFeedRequest) returns (GetFeedResponse)`  
**HTTP:** `GET /feed`  
**FR:** FR-044-045, FR-068-069, FR-158-164

Получение ленты "лучших" постов с ранжированием.

**Request:**

```protobuf
message GetFeedRequest {
  TimePeriod time_period        // фильтр по времени
  optional string community_id  // если пусто - глобальная лента
  string cursor
  int32 limit
}
```

**Response:**

```protobuf
message GetFeedResponse {
  repeated Post posts
  string next_cursor
  bool has_more
}
```

**Требования:**

- Cursor-based пагинация (FR-161)
- Сортировка по engagement score (FR-162)
- Без community_id: глобальная лента всех сообществ (FR-163)
- С community_id: только посты из этого сообщества (FR-164)

**Time Periods (FR-044):**

- TODAY: посты за последние 24 часа
- WEEK: посты за последнюю неделю
- MONTH: посты за последний месяц
- YEAR: посты за последний год
- ALL_TIME: все посты без ограничения

---

### GetPersonalizedFeed

**RPC:** `GetPersonalizedFeed(GetPersonalizedFeedRequest) returns (GetPersonalizedFeedResponse)`  
**HTTP:** `GET /feed/personalized`  
**FR:** FR-195-207

Персонализированная лента на основе подписок и членства.

**Request:**

```protobuf
message GetPersonalizedFeedRequest {
  string cursor
  int32 limit
}
```

**Response:**

```protobuf
message GetPersonalizedFeedResponse {
  repeated Post posts  // из followed users + joined communities
  string next_cursor
  bool has_more
}
```

**Требования:**

- Cursor-based пагинация (FR-200)
- Посты от пользователей, на которых подписан текущий пользователь (FR-196)
- Посты из сообществ, в которых состоит текущий пользователь (FR-197)
- Объединенная лента из обоих источников (FR-198)
- Сортировка по published_at в обратном порядке (новые первые) (FR-199)
- Дедупликация по post_id (FR-205)
- При дублях сохраняется оригинальная дата публикации (FR-207)
- Пустая лента если нет подписок и не состоит в сообществах (FR-201)
- Требуется аутентификация

**Ошибки:**

- Пользователь не аутентифицирован

---

## Алгоритм ранжирования "Best"

### Формула

```
Score = log10(max(abs(Likes), 1)) + (Comments × 0.1) - (Age_in_hours / 12)
```

**Компоненты (FR-045, FR-068):**

1. **log10(max(abs(Likes), 1))**

   - Логарифмическое масштабирование лайков
   - Минимум 1 для избежания log(0)
   - Чем больше лайков, тем выше score (но с уменьшающейся отдачей)

2. **Comments × 0.1**

   - Линейный вес комментариев
   - 10 комментариев = 1 балл
   - Поощряет дискуссии

3. **Age_in_hours / 12**
   - Штраф за старение
   - Каждые 12 часов = -1 балл
   - Новый контент получает преимущество

### Примеры

**Свежий популярный пост:**

- 100 лайков, 50 комментариев, 2 часа
- Score = log10(100) + (50 × 0.1) - (2 / 12)
- Score = 2 + 5 - 0.17 = 6.83

**Старый популярный пост:**

- 100 лайков, 50 комментариев, 48 часов
- Score = 2 + 5 - 4 = 3.0

**Новый с низким engagement:**

- 1 лайк, 0 комментариев, 1 час
- Score = 0 + 0 - 0.08 = -0.08

### Приоритеты (FR-068)

- Высокий engagement (лайки + комментарии)
- Преимущество новым постам
- Баланс между популярностью и свежестью

### Применение (FR-069)

Внутри каждого time period посты сортируются по score в обратном порядке (высокий score первым).

---

## Персонализированная лента

### Источники контента

**1. Подписки на пользователей (FR-196):**

- Посты от всех followed users
- Только опубликованные посты
- Независимо от сообщества

**2. Членство в сообществах (FR-197):**

- Посты из всех joined communities
- Только опубликованные посты
- От любых авторов в сообществе

### Объединение (FR-198)

Оба источника объединяются в единую ленту с:

- Сортировкой по published_at
- Дедупликацией по post_id

### Дедупликация

**Сценарий:**
Пользователь подписан на Author A И состоит в Community C.
Author A публикует пост в Community C.

**Результат (FR-205-207):**

- Пост появляется ОДИН раз в ленте
- Используется оригинальная дата published_at
- Неважно из какого источника он пришел

### Пустая лента (FR-201)

Если пользователь:

- Не подписан ни на кого И
- Не состоит ни в каких сообществах

Лента возвращает пустой массив постов.

### Производительность

**Оптимизация для 5000 подписок (FR-250, FR-202):**

- Эффективные JOIN запросы
- Индексы на (author_id, published_at)
- Индексы на (community_id, published_at)
- Cursor pagination для масштабирования

---

## Глобальная лента vs Сообщества

### Глобальная лента (community_id не указан)

- Агрегация постов из всех сообществ
- Ранжирование по score
- Фильтрация по time_period
- Доступна всем пользователям (включая неаутентифицированных)

### Лента сообщества (community_id указан)

- Только посты из конкретного сообщества
- Ранжирование по score
- Фильтрация по time_period
- Доступна всем, включая не-участников

### Сравнение с персонализированной

| Критерий       | Best Feed        | Personalized Feed |
| -------------- | ---------------- | ----------------- |
| Сортировка     | Engagement score | Хронологическая   |
| Источник       | Все/сообщество   | Подписки+членство |
| Фильтр времени | Да (time_period) | Нет               |
| Требует auth   | Нет              | Да                |

---

## Фильтрация контента

### Исключения из лент

Не показываются в лентах:

- Черновики (status = draft)
- Посты из забаненных сообществ (для не-модераторов)
- Посты удаленных пользователей (опционально)

### Видимость для модераторов

Модераторы с view_all_communities могут видеть:

- Посты из забаненных сообществ
- С соответствующими индикаторами

---

## Cursor Pagination

### Реализация для Best Feed

Cursor кодирует:

- Последний score
- Последний post_id (для стабильной сортировки)
- Time period (для консистентности)

### Реализация для Personalized Feed

Cursor кодирует:

- Последний published_at timestamp
- Последний post_id

### Стабильность

- Cursor должен быть идемпотентным
- Новые посты не должны нарушать пагинацию
- Дубликаты должны предотвращаться

---

## Производительность

### Целевые метрики

- Возврат результатов < 2 секунды (SC-005)
- Поддержка высоконагруженных запросов
- Эффективная работа с 100,000+ постов

### Оптимизации

**Индексы:**

- (community_id, published_at, score) для Best Feed
- (author_id, published_at) для personalized
- (community_id, published_at) для personalized

**Кеширование:**

- Hot feed (первая страница Best/Today)
- Счетчики engagement
- Metadata сообществ и авторов

**Денормализация:**

- author_username в Post
- community_name в Post
- Избежание дополнительных JOIN

---

## Уведомления и обновления

### Триггеры для персонализированной ленты

Когда новый пост публикуется:

1. Уведомления подписчикам автора (NEW_POST_FROM_FOLLOWED_USER)
2. Уведомления участникам сообщества (NEW_POST_IN_COMMUNITY)
3. Пост появляется в персонализированной ленте

### Real-time обновления

Ленты НЕ обновляются в real-time:

- Клиент использует polling или pull-to-refresh
- Альтернатива: WebSocket уведомления о новом контенте
- Full stream комментариев доступен отдельно

---

## Ограничения

### Персонализированная лента

- Максимум 5000 подписок учитывается (FR-202)
- Неограниченное количество сообществ
- Требуется аутентификация

### Best Feed

- Без лимитов на количество постов
- Доступна анонимным пользователям
- Time period фильтрует результаты

---

## Рекомендации по реализации

### Расчет score

- Выполнять на стороне БД (SQL функция)
- Материализованное представление для hot posts
- Периодический пересчет (каждые 10-15 минут)

### Кеширование

- Redis для hot feeds
- TTL 5-10 минут
- Invalidation при новых постах с высоким engagement

### Monitoring

- Latency метрики по типам лент
- Количество запросов к лентам
- Распределение time periods
- Empty feed rate для personalized
