# Архитектура платформы мультиблогов

## Общее описание

Платформа мультиблогов представляет собой современную систему для создания и управления контентом в формате сообществ, аналогичную DTF.ru, dev.to, Reddit, Pikabu.

## Технологический стек

### Протокол взаимодействия

- **gRPC** - основной протокол для всех операций
- **grpc-gateway** - REST API proxy для HTTP клиентов
- **Swagger/OpenAPI** - автоматически генерируемая документация API

### Аутентификация

- **JWT токены** - access token (15 минут) и refresh token (7 дней)
- Передача через gRPC Metadata в заголовке Authorization (Bearer token)

### Хранение данных

- **PostgreSQL** - основная реляционная БД для структурированных данных
- **PostgreSQL Full-Text Search** - поиск с GIN индексами
- **S3-совместимое хранилище** - все медиа файлы (изображения, видео, аудио, аватары, баннеры)

### Real-time коммуникация

- **gRPC Server-Side Streaming** для:
  - Комментариев в реальном времени (глобальный поток и по посту)
  - Обновлений разрешений пользователей
  - Уведомлений

## Архитектурные компоненты

### gRPC Services

Система разделена на 15 независимых gRPC сервисов:

1. **AuthorizationService** - регистрация, вход, управление сессиями
2. **UserService** - профили пользователей, подписки, статистика, онлайн-статус
3. **CommunityService** - создание и управление сообществами, рейтинг
4. **PostService** - посты, лайки, закладки
5. **CommentService** - комментарии с real-time streaming
6. **FeedService** - ленты контента (по популярности и персонализированная)
7. **RoleService** - создание и управление ролями
8. **PermissionService** - система разрешений с real-time streaming
9. **PlatformService** - настройки платформы, статистика
10. **ModerationService** - модерация пользователей и контента
11. **ReportService** - система жалоб на контент
12. **MediaService** - загрузка медиа файлов
13. **NotificationService** - уведомления с real-time streaming
14. **SearchService** - унифицированный поиск
15. **BadgeService** - система наград для пользователей и сообществ

### Пагинация

Все списковые операции используют cursor-based пагинацию:

- `cursor` - непрозрачный токен состояния (timestamp, ID или составной ключ)
- `next_cursor` - токен для следующей страницы
- `has_more` - флаг наличия дополнительных данных
- `limit` - количество записей на странице

### Безопасность

#### Rate Limiting

- 5 попыток входа за 10 минут на IP адрес
- 100 API запросов в минуту на аутентифицированного пользователя
- HTTP 429 при превышении лимитов

#### Пароли

- Минимум 12 символов
- Проверка через Have I Been Pwned API
- Отклонение скомпрометированных паролей

#### Авторизация

- Валидация JWT через gRPC interceptors
- Независимая проверка разрешений на сервере для каждой операции
- gRPC код ошибки Unauthenticated (16) для невалидных токенов
- gRPC код ошибки PermissionDenied (7) при отсутствии прав

## Ключевые сущности

### User

Пользователь платформы с аутентификационными данными, профилем, статусом верификации email, репутацией и онлайн-статусом (based on last_activity timestamp).

### Community

Организационная единица для постов с владельцем, модераторами, настройками, списком участников и рейтингом сообщества (calculated from post likes and comments).

### Post

Пользовательский контент с заголовком, JSON содержимым, автором, сообществом, статусом (черновик/опубликован).

### Comment

Ответы на посты с текстом, автором, опциональным родительским комментарием (для вложенности), медиа вложениями.

### Role

Набор разрешений с именем, цветом, типом (платформенная/сообщества). Может быть назначен пользователям.

### Bookmark

Сохраненные посты пользователя.

### Like

Позитивная реакция пользователя на пост или комментарий.

### Report

Жалоба на контент с информацией о репортере, контенте, причине, статусе обработки.

### Follow

Односторонняя подписка между пользователями (Twitter-модель).

### Notification

Уведомление о событиях на платформе, доставляемое в реальном времени через streaming.

### Badge

Награда (достижение) для пользователей и сообществ с названием, описанием, иконкой и уровнем редкости (common, rare, epic, legendary). Может быть платформенной или наградой сообщества. Награды сообщества требуют модерации платформой.

## Система ролей и разрешений

### Типы ролей

- **Платформенные роли** - действуют на всей платформе
- **Роли сообщества** - действуют только внутри конкретного сообщества

### Специальная роль @everyone

- Автоматически создается для платформы и каждого сообщества
- Не может быть удалена или переименована
- Разрешения могут редактироваться владельцами
- Автоматически назначается:
  - Платформенная @everyone - всем зарегистрированным
  - Сообщества @everyone - всем участникам сообщества
- Автоматически удаляется при выходе из сообщества

### Расчет разрешений

Эффективные разрешения пользователя = объединение (union) разрешений всех его ролей.

### Категории разрешений

**Модерация** (6 разрешений):

- ban_users, mute_users, delete_any_post, delete_any_comment, unpublish_post, view_moderation_logs

**Контент** (8 разрешений):

- create_post, edit_own_post, delete_own_post, create_comment, edit_own_comment, delete_own_comment, like_content, bookmark_content

**Сообщества** (9 разрешений):

- create_community, edit_community_settings, delete_community, transfer_community_ownership, manage_community_members, assign_community_roles, create_community_roles, edit_community_roles, delete_community_roles

**Платформа** (9 разрешений):

- edit_platform_settings, transfer_platform_ownership, manage_platform_users, assign_platform_roles, create_platform_roles, edit_platform_roles, delete_platform_roles, view_all_communities, view_analytics

**Жалобы** (4 разрешения):

- report_content, view_reports, resolve_reports, dismiss_reports

**Расширенные** (7 разрешений):

- pin_post, unpin_post, lock_thread, unlock_thread, feature_post, edit_any_post, edit_any_comment

**Награды** (9 разрешений):

- create_platform_badges, edit_platform_badges, delete_platform_badges, award_platform_badges, create_community_badges, edit_community_badges, delete_community_badges, award_community_badges, approve_community_badges

## Потоки real-time данных

### Comment Streaming

- **Post-specific stream** - только комментарии к конкретному посту
- **Global stream** - все комментарии платформы
- События: CREATED, UPDATED, DELETED

### Permission Streaming

- Обновления при изменении ролей пользователя
- Обновления при редактировании разрешений ролей
- Обновления при вступлении/выходе из сообществ

### Notification Streaming

- 5 типов уведомлений
- Персонализированные настройки подписки
- Автоудаление через 90 дней
- Максимум 10 одновременных подключений на пользователя

## Модель репутации

### Репутация пользователей

Репутация пользователя = сумма всех лайков на его постах и комментариях.

### Рейтинг сообществ

Рейтинг сообщества = sum(post_likes) + (sum(comments) × 0.1)

Автоматически обновляется при получении лайков на постах или создании комментариев в сообществе.

### Онлайн-статус пользователей

- Heartbeat mechanism: клиент отправляет запрос каждые 30-60 секунд
- Пользователь онлайн если last_activity < 5 минут
- Статус обновляется при любом authenticated API запросе
- Heartbeat запросы НЕ учитываются в rate limiting

## Алгоритм ранжирования "Best"

```
Score = log10(max(abs(Likes), 1)) + (Comments × 0.1) - (Age_in_hours / 12)
```

Применяется для лент с фильтрацией по периодам: сегодня, неделя, месяц, год, все время.

## Лимиты и ограничения

### Медиа файлы

- Изображения: 10MB
- Видео: 100MB
- Аудио: 20MB
- GIF: 15MB
- Максимум 5 файлов на комментарий

### Подписки

- Максимум 5000 подписок на пользователя

### Конкурентные подключения

- Максимум 10 notification streaming подключений на пользователя

### История

- Уведомления удаляются через 90 дней
